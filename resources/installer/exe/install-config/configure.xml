<?xml version="1.0"?>
<project name="lsFusion post-install configurator">
    <taskdef resource="net/sf/antcontrib/antcontrib.properties"/>

    <property file="configure.properties" />

    <target name="configureWebClient">
        <replace file="${web.conf}" token="localhost" value="${server.host}" encoding="UTF-8"/>
        <replace file="${web.conf}" token="7652" value="${server.port}" encoding="UTF-8"/>

        <if>
            <not>
                <equals arg1="${web.dir}" arg2="" />
            </not>
            <then>
                <copy file="${web.conf}" tofile="${web.dir}/../conf/catalina/localhost/${web.context.file}.xml" />
                <copy file="${web.archive}" tofile="${web.dir}/${web.context.file}.war" />
            </then>
        </if>
    </target>

    <target name="configureTomcat">
        <replace file="${tomcat.dir}/conf/server.xml" token="8005" value="${tomcat.shutdownPort}" />
        <replace file="${tomcat.dir}/conf/server.xml" token="8009" value="${tomcat.ajpPort}" />
        <replace file="${tomcat.dir}/conf/server.xml" token="8080" value="${tomcat.httpPort}" />
    </target>

    <target name="configureIdea">
        <unzip src="../${idea.plugin}" dest="${idea.dir}/plugins/" />
        
        <replace file="jdk.table.xml" token="java.home" value="${jdk.home}" />
        <replace file="jdk.table.xml" token="java.majorversion" value="${jdk.majorversion}" />
        <replace file="jdk.table.xml" token="java.version" value="${jdk.version}" />
        <copy file="jdk.table.xml" tofile="${user.home}/.IdeaIC${idea.majorversion}/config/options/jdk.table.xml" />

        <replaceregexp file="${idea.dir}/bin/idea.exe.vmoptions" match="Xmx.*m" replace="Xmx1200m"/>
        <replaceregexp file="${idea.dir}/bin/idea64.exe.vmoptions" match="Xmx.*m" replace="Xmx2g"/>

        <if>
            <not>
                <equals arg1="${lsfusion.library.name}" arg2="" />
            </not>
            <then>
                <replace file="applicationLibraries.xml" token="lsfusion.library.name" value="${lsfusion.library.name}" />
                <replace file="applicationLibraries.xml" token="server.archive" value="${server.archive}" />
                <replace file="applicationLibraries.xml" token="server.sources" value="${server.sources}" />
                <copy file="applicationLibraries.xml" tofile="${user.home}/.IdeaIC${idea.majorversion}/config/options/applicationLibraries.xml" />
            </then>
        </if>

        <replace file="options.xml" token="db.host" value="${db.host}" />
        <replace file="options.xml" token="db.port" value="${db.port}" />
        <replace file="options.xml" token="db.user" value="${db.user}" />
        <replace file="options.xml" token="db.pass" value="${db.pass}" />
        <if>
            <isset property="admin.pass"/>
            <then>
                <replace file="options.xml" token="admin.pass" value="${admin.pass}" />
            </then>
            <else>
                <replace file="options.xml" token="admin.pass" value="" />
            </else>
        </if>
        <copy file="options.xml" tofile="${user.home}/.IdeaIC${idea.majorversion}/config/options/options.xml" />
    </target>
</project>
